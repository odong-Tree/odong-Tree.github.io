---
layout: post
title: 메모리 구조, Stack과 Heap
category: CS
tags: [Stack, Heap, 메모리]
comments: true
---
>이 글은 공부 중에 작성하는 글입니다.       
>정정이 필요한 내용은 댓글로 알려주시면 감사하겠습니다 :)

<br>

안녕하세요 오동나무입니다.  <br>

오늘은 메모리 구조에 대해서 알아보도록 하겠습니다. 기본적인 내용 이후로는 개인적인 궁금증을 토대로 작성합니다 :)

<br>
<br>

# 메모리 구조
프로그램을 실행하면 운영체제는 메모리에 공간을 할당하게 됩니다. 그리고 그 메모리는 Code, Data, Stack, Heap 4가지 영역으로 구성되어 있습니다.

<img src = "/assets/post-img/cs/memory1.jpg">     

### ✐ 코드 영역 (Code)
우리가 작성한 소스코드가 기계어의 형태로 저장되는 영역입니다. 즉, 실행할 코드가 저장되는 영역으로 **텍스트 영역** 이라고도 부릅니다. 코드 영역은 컴파일 타임에 결정되며 중간에 수정될 수 없습니다.

<br>

### ✐ 데이터 영역 (Data)
코드에서 선언한 전역변수 또는 static 변수 등이 저장되는 공간입니다. 프로그램의 시작과 동시에 할당되고, 프로그램이 종료되어야 메모리가 소멸됩니다. 실행 도중에 전역변수가 변경 될 수도 있으니 데이터 영역은 수정될 수 있습니다.

<br>

### ✐ 스택 영역 (Stack)
프로그램이 자동으로 사용하는 임시 메모리 영역으로 함수 호출 시 생성되는 지역 변수, 매개변수 등이 저장되며 함수 호출이 완료되면 사라집니다. 즉, 스택변수는 함수가 실행되는 도중에만 존재합니다. 기록하고 종료하는 메커니즘은 LIFO (Last-In, First-Out) 방식을 따릅니다. <br>

컴파일 시점에서 메모리 크기가 결정되며 메모리 크기를 변경할 수 없습니다. 또한 접근에 있어서 힙보다 빠른 속도를 가지고 있습니다.    

>**Data 영역과 BSS(Block Stated Symbol) 영역**
Data 영역은 BSS 영역과 Data 영역으로 나뉜다고 합니다. Data 영역에는 초기화가 이루어진 변수들이  저장되며 위의 설명과 동일합니다. 반면 BSS는 선언만 되고 아직 초기화가 이루어지지  않은 데이터를 저장합니다. 따라서 메모리 공간을 보다 효율적으로 사용하게 됩니다.

<br>

### ✐ 힙 영역 (Heap)
프로그래머가 필요할 때 할당/해제 하는 영역입니다. 다른 메모리 영역과는 다르게 런타임에 결정됩니다. 이 영역에 메모리를 할당하는 것을 **동적 할당(Dynamic Memory Allocation)** 이라고 부릅니다. <br>

메모리 크기가 동적으로 결정되어 변경이 가능하다는 점에서 효율적이지만 포인터로 메모리 영역에 접근해야하기  때문에 다른 자료 구조에  비해서 데이터를 읽고 쓰는 속도가 느립니다.

<br>
<br>

# Stack과 Heap
스택은 정적 메모리 구조를 가지고 힙은 동적 메모리 구조를 가집니다. 그리고 스택 영역과 힙 영역은 메모리 공간을 공유합니다. 따라서 스택 영역이 공간을 많이 차지하게 되면 힙 영역의 공간이 줄어들게 됩니다. 반대로 힙이 많은 메모리 공간을 차지하고 있다면 스택은 보다 작은 공간을 차지하고 있겠지요. <br>

스택과 힙은 먼저 접근하는 속도에서 차이가 납니다.
<br>

### ✐ 높은 주소와 낮은 주소
스택 영역은 높은 주소에서 낮은 주소로 메모리에 할당이 되고, 힙 영역은 낮은 주소에서 높은 주소로 할당이 됩니다. 그러니까, 스택은 위에서 부터 공간을 차지하고, 힙은 아래에서부터 공간을 차지한다는 이야기입니다. 한 공간의 메모리를 공유해야하기 때문에 서로 양끝의 출발점에서 시작해야 만날 가능성이 적겠죠?

<img src = "/assets/post-img/cs/memory2.jpg">      

이렇게 스택과 힙 영역이 서로 다른 주소값 출발점을 가지고, 쌍방향으로 메모리를 쌓게 되면 커널 영역에 침범하지 않게 되고, 공유 라이브러리를 효율적으로 사용할 수 있게 됩니다.

<br>

### ✐ OverFlow
스택과 힙은 이러한 관계를 가지고 있기 때문에 만약 한쪽 영역이 사용할 수 있는 공간을 넘어가 버리면 서로의 영역을 침범하게 됩니다. 이러한 경우, 스택이 힙 영역을 침범하는 경우를 **StackOverFlow**, 힙 영역이 스택 영역을 침범하는 경우를 **HeapOverFlow** 라고 합니다. <br>

<br>

### ✐ 스레드의 공유자원
하나의 프로세스는 여러개의 스레드를 가질 수 있습니다. 그리고 이 스레드들은 모든 영역의 메모리를 공유하는 것이 아니라, Code, Data, Heap 영역만을 공유합니다. Stack 영역은 공유하지 않고 각각의 스레드가 가지고 있는 형태입니다. 따라서 모든 스레드가 공유해야할 전역 변수 등은 Data 영역에 저장해야 합니다.

<br>
<br>

# Swift에서 메모리 관리, ARC

Swift에서는 [ARC(Auto Reference Counting)](https://odong-tree.github.io/swift/2021/01/01/strong_weak/)가 자동으로 메모리 관리를 해줍니다. 스택 영역은 컴파일 타임에서 고정적인 메모리가 정해지므로 ARC가 필요가 없지만, 동적으로 크기가 변하는 힙 영역에서는 ARC가 메모리 관리를 도와줍니다. 따라서 프로그래머가 직접적으로 메모리 할당과 해제를 관리해줄 필요는 없습니다. 하지만 메모리가 어떻게 관리되는지 알고 코드를 짜야 좀 더 효율적으로 메모리를 사용할 수 있을 것 같습니다 :)



<br>
<br>

#### 참고
- [https://selfish-developer.com/entry/스택-힙-코드-데이터영역](https://selfish-developer.com/entry/스택-힙-코드-데이터영역)
- [https://velog.io/@goserimgoserimgo/메모리-구조](https://velog.io/@goserimgoserimgo/메모리-구조)
- [https://velog.io/@raejoonee/프로세스와-스레드의-차이](https://velog.io/@raejoonee/프로세스와-스레드의-차이)

<br>
<br>
